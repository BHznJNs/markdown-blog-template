{"version":3,"file":"searchBox.min.js","sources":["../../src/components/fullscreen.js","../../src/components/searchBox.js"],"sourcesContent":["import el from \"../utils/dom/el.js\"\r\n\r\nclass FullscreenMask extends HTMLElement {\r\n    constructor() {\r\n        super()\r\n    }\r\n}\r\ncustomElements.define(\"fullscreen-mask\", FullscreenMask)\r\n\r\nexport default class FullscreenView extends HTMLElement {\r\n    constructor() {\r\n        super()\r\n\r\n        const mask = new FullscreenMask()\r\n        mask.addEventListener(\"click\", () =>\r\n            this.toggle(false))\r\n\r\n        const container = el(\"div\", \"\", {\r\n            \"class\": \"container\"\r\n        })\r\n\r\n        this.classList.add(\"fullscreen\")\r\n        this.mask = mask\r\n        this.container = container\r\n        this.appendChild(mask)\r\n        this.appendChild(container)\r\n    }\r\n\r\n    appendToContainer(el) {\r\n        this.container.appendChild(el)\r\n    }\r\n\r\n    toggle(force) {\r\n        this.mask.classList.toggle(\"show\", force)\r\n        this.container.classList.toggle(\"show\", force)\r\n        this.toggleCallback(force)\r\n    }\r\n    toggleCallback(force) {}\r\n}\r\ncustomElements.define(\"fullscreen-view\", FullscreenView)\r\n","import \"../styles/components/searchBox.css\"\r\nimport FullscreenView from \"./fullscreen.js\"\r\nimport importStyle from \"../scripts/importers/style\"\r\nimport pathManager from \"../scripts/pathManager.js\"\r\nimport flexsearch from \"../libs/flexsearch/flexsearch.bundle.module.min.js\"\r\nimport languageSelector from \"../utils/languageSelector.js\"\r\nimport eventbus from \"../utils/eventbus/inst.js\"\r\nimport el from \"../utils/dom/el.js\"\r\nimport { tokenize } from \"../utils/countWord.js\"\r\nimport throttle from \"../utils/throttle.js\"\r\n\r\nfunction indexFactory(indexData) {\r\n    const index = new flexsearch.Index({\r\n        preset: \"memory\",\r\n        optimize: true,\r\n        encode: tokenize,\r\n    })\r\n\r\n    if (indexData !== undefined) {\r\n        for (const [key, data] of Object.entries(indexData)) {\r\n            index.import(key, data)\r\n        }\r\n    }\r\n    return index\r\n}\r\n\r\nclass PageController {\r\n    pageList = []\r\n    maximum = 0\r\n    current = 0\r\n\r\n    #search(id, query) {\r\n        const {index, idMap} = this.pageList[id]\r\n        const searchResult = index.search(query)\r\n        return searchResult.map(itemIndex => idMap[itemIndex])\r\n    }\r\n\r\n    async #importer(id) {\r\n        const file = await fetch(`./.index/search-index_${id}.json`)\r\n        const json = await file.json()\r\n        const { idMap, maxId, ...indexData } = json\r\n\r\n        this.maximum = maxId\r\n        this.pageList.push({\r\n            idMap,\r\n            index: indexFactory(indexData)\r\n        })\r\n    }\r\n\r\n    get hasMorePage() {\r\n        return this.current < this.maximum\r\n    }\r\n\r\n    async search(query) {\r\n        const id = this.current\r\n\r\n        if (this.pageList[id] === undefined) {\r\n            // is not imported page, import it\r\n            await this.#importer(id)\r\n        }\r\n        return this.#search(id, query)\r\n    }\r\n\r\n    async searchNext(query) {\r\n        this.current += 1\r\n        return await this.search(query)\r\n    }\r\n}\r\n\r\nclass SearchBox extends FullscreenView {\r\n    pageController = new PageController\r\n\r\n    constructor() {\r\n        super()\r\n\r\n        importStyle(\"./dist/chunks/searchBox.min.css\")\r\n\r\n        this.input = el(\"input\", \"\", {\r\n            type: \"text\",\r\n            placeholder: languageSelector(\"搜索\", \"Search\"),\r\n        })\r\n        this.searchBtn = el(\"button\", el(\"img\", \"\", {\r\n            src: \"./dist/imgs/search.svg\"\r\n        }), {\r\n            \"class\": \"icon-btn search-btn\",\r\n            title: languageSelector(\"搜索图标\", \"Search Icon\")\r\n        })\r\n\r\n        const inputGroup = el(\"div\", [this.input, this.searchBtn], {\r\n            \"class\": \"input-group\"\r\n        })\r\n        const noResultText = el(\"p\", languageSelector(\"无结果\", \"No search result\"), {\r\n            \"class\": \"no-result\"\r\n        })\r\n\r\n        this.loadMoreBtn = el(\r\n            \"button\",\r\n            languageSelector(\"加载更多\", \"Load More\"), {\r\n            \"class\": \"icon-btn loadmore-btn\"\r\n        })\r\n        this.resultList = el(\"ul\", \"\")\r\n        this.resultContainer = el(\"div\", [\r\n            this.resultList,\r\n            noResultText,\r\n            this.loadMoreBtn,\r\n        ], {\r\n            \"class\": \"result-container\"\r\n        })\r\n\r\n        this.appendToContainer(inputGroup)\r\n        this.appendToContainer(this.resultContainer)\r\n        this.#appendEvents()\r\n        this.toggleCallback(false)\r\n    }\r\n\r\n    toggleCallback(force) {\r\n        const focusableElements = [\r\n            this.input,\r\n            this.searchBtn,\r\n            this.loadMoreBtn,\r\n            ...this.resultList.children,\r\n        ]\r\n        const tabIndex = force ? 0 : -1\r\n        for (const el of focusableElements) {\r\n            el.tabIndex = tabIndex\r\n        }\r\n    }\r\n\r\n    clear() {\r\n        this.pageController.current = 0\r\n        this.resultList.innerHTML = \"\"\r\n        this.resultContainer.classList.remove(\"show\")\r\n    }\r\n\r\n    #showSearchResults(searchResult) {\r\n        const itemElFactory = content =>\r\n            el(\"li\", el(\"span\", content, {\r\n                \"class\": \"underline-target\"\r\n            }), {\r\n                \"class\": \"underline-through\",\r\n                tabindex: 0,\r\n            })\r\n\r\n        const frac = document.createDocumentFragment()\r\n        searchResult\r\n            .map(itemElFactory)\r\n            .forEach(el => frac.appendChild(el))\r\n        this.resultList.appendChild(frac)\r\n        this.resultContainer.classList.add(\"show\")\r\n\r\n        this.loadMoreBtn.disabled = false\r\n        this.loadMoreBtn.classList.toggle(\"show\", this.pageController.hasMorePage)\r\n    }\r\n\r\n    #appendEvents() {\r\n        // when open, focus on the input\r\n        eventbus.on(\"searchbox-show\", () => {\r\n            this.toggle(true)\r\n            this.container.addEventListener(\r\n                \"transitionend\",\r\n                () => this.input.focus(),\r\n                { once: true },\r\n            )\r\n        })\r\n\r\n        // open article\r\n        this.resultList.addEventListener(\"click\", e => {\r\n            const target = e.target\r\n            if (target === this.resultList) {\r\n                return\r\n            }\r\n            const targetArticle = \"static/\" + target.textContent\r\n            pathManager.jumpTo(targetArticle)\r\n            this.toggle(false)\r\n        })\r\n\r\n        // clear search result when `input`is empty\r\n        this.input.addEventListener(\"input\", this.clear.bind(this))\r\n\r\n        // `Enter` key or click the search button to start search\r\n        const searchThrottled = throttle(() => {\r\n            this.clear()\r\n            const searchText = this.input.value\r\n            this.pageController.search(searchText)\r\n                .then(this.#showSearchResults.bind(this))\r\n        }, 1000)\r\n        this.searchBtn.addEventListener(\"click\", searchThrottled)\r\n        this.input.addEventListener(\"keydown\", e => {\r\n            if (e.key !== \"Enter\") {\r\n                return\r\n            }\r\n            searchThrottled()\r\n        })\r\n\r\n        // load more button click event\r\n        this.loadMoreBtn.addEventListener(\"click\", () => {\r\n            const searchText = this.input.value\r\n            this.loadMoreBtn.disabled = true\r\n            this.pageController.searchNext(searchText)\r\n                .then(this.#showSearchResults.bind(this))\r\n        })\r\n    }\r\n}\r\ncustomElements.define(\"search-box\", SearchBox)\r\n"],"names":["FullscreenMask","HTMLElement","constructor","super","customElements","define","FullscreenView","mask","addEventListener","this","toggle","container","el","class","classList","add","appendChild","appendToContainer","force","toggleCallback","indexFactory","indexData","index","flexsearch","Index","preset","optimize","encode","tokenize","undefined","key","data","Object","entries","import","PageController","pageList","maximum","current","search","id","query","idMap","map","itemIndex","importer","file","fetch","json","maxId","push","hasMorePage","searchNext","pageController","importStyle","input","type","placeholder","languageSelector","searchBtn","src","title","inputGroup","noResultText","loadMoreBtn","resultList","resultContainer","appendEvents","focusableElements","children","tabIndex","clear","innerHTML","remove","showSearchResults","searchResult","frac","document","createDocumentFragment","content","tabindex","forEach","disabled","eventbus","on","focus","once","e","target","targetArticle","textContent","pathManager","jumpTo","bind","searchThrottled","throttle","searchText","value","then"],"mappings":"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"}