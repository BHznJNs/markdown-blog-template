import{_ as n,s as r,N as t,f as e,r as o,m as i,c as a,o as s,aX as u,cW as c,P as h,a2 as f,K as l,R as d,d as p,Y as g,X as v,cX as _,B as m}from"./core.js";import{t as b,r as y}from"./interactionMutex.js";import{o as C}from"./cursorHelper.js";var w=!0,T=Math.min,O=Math.max,R=Math.pow,B=1e4,E=6,k=6,S="globalPan",z={w:[0,0],e:[0,1],n:[1,0],s:[1,1]},x={w:"ew",e:"ew",n:"ns",s:"ns",ne:"nesw",sw:"nesw",nw:"nwse",se:"nwse"},X={brushStyle:{lineWidth:2,stroke:"rgba(210,219,238,0.3)",fill:"#D2DBEE"},transformable:!0,brushMode:"single",removeOnClick:!1},P=0,I=function(c){function h(n){var i=c.call(this)||this;return i._track=[],i._covers=[],i._handlers={},r(n),i._zr=n,i.group=new t,i._uid="brushController_"+P++,e(un,(function(n,r){this._handlers[r]=o(n,this)}),i),i}return n(h,c),h.prototype.enableBrush=function(n){return r(this._mounted),this._brushType&&this._doDisableBrush(),n.brushType&&this._doEnableBrush(n),this},h.prototype._doEnableBrush=function(n){var r=this._zr;this._enableGlobalPan||b(r,S,this._uid),e(this._handlers,(function(n,t){r.on(t,n)})),this._brushType=n.brushType,this._brushOption=i(a(X),n,!0)},h.prototype._doDisableBrush=function(){var n=this._zr;y(n,S,this._uid),e(this._handlers,(function(r,t){n.off(t,r)})),this._brushType=this._brushOption=null},h.prototype.setPanels=function(n){if(n&&n.length){var r=this._panels={};e(n,(function(n){r[n.panelId]=a(n)}))}else this._panels=null;return this},h.prototype.mount=function(n){n=n||{},this._mounted=!0,this._enableGlobalPan=n.enableGlobalPan;var r=this.group;return this._zr.add(r),r.attr({x:n.x||0,y:n.y||0,rotation:n.rotation||0,scaleX:n.scaleX||1,scaleY:n.scaleY||1}),this._transform=r.getLocalTransform(),this},h.prototype.updateCovers=function(n){r(this._mounted),n=s(n,(function(n){return i(a(X),n,!0)}));var t="\0-brush-index-",e=this._covers,o=this._covers=[],c=this,h=this._creatingCover;return new u(e,n,(function(n,r){return f(n.__brushOption,r)}),f).add(l).update(l).remove((function(n){e[n]!==h&&c.group.remove(e[n])})).execute(),this;function f(n,r){return(null!=n.id?n.id:t+r)+"-"+n.brushType}function l(r,t){var i=n[r];if(null!=t&&e[t]===h)o[r]=e[t];else{var a=o[r]=null!=t?(e[t].__brushOption=i,e[t]):M(c,L(c,i));D(c,a)}}},h.prototype.unmount=function(){if(this._mounted)return this.enableBrush(!1),G(this),this._zr.remove(this.group),this._mounted=!1,this},h.prototype.dispose=function(){this.unmount(),this.off()},h}(c);function L(n,r){var t=hn[r.brushType].createCover(n,r);return t.__brushOption=r,j(t,r),n.group.add(t),t}function M(n,r){var t=N(r);return t.endCreating&&(t.endCreating(n,r),j(r,r.__brushOption)),r}function Y(n,r){var t=r.__brushOption;N(r).updateCoverShape(n,r,t.range,t)}function j(n,r){var t=r.z;null==t&&(t=B),n.traverse((function(n){n.z=t,n.z2=t}))}function D(n,r){N(r).updateCommon(n,r),Y(n,r)}function N(n){return hn[n.__brushOption.brushType]}function W(n,r,t){var o,i=n._panels;if(!i)return w;var a=n._transform;return e(i,(function(n){n.isTargetByCursor(r,t,a)&&(o=n)})),o}function A(n,r){var t=n._panels;if(!t)return w;var e=r.__brushOption.panelId;return null!=e?t[e]:w}function G(n){var r=n._covers,t=r.length;return e(r,(function(r){n.group.remove(r)}),n),r.length=0,!!t}function H(n,r){var t=s(n._covers,(function(n){var r=n.__brushOption,t=a(r.range);return{brushType:r.brushType,panelId:r.panelId,range:t}}));n.trigger("brush",{areas:t,isEnd:!!r.isEnd,removeOnClick:!!r.removeOnClick})}function K(n){var r=n.length-1;return r<0&&(r=0),[n[0],n[r]]}function U(n,r,o,i){var a=new t;return a.add(new d({name:"main",style:Q(o),silent:!0,draggable:!0,cursor:"move",drift:l($,n,r,a,["n","s","w","e"]),ondragend:l(H,r,{isEnd:!0})})),e(i,(function(t){a.add(new d({name:t.join(""),style:{opacity:0},draggable:!0,silent:!0,invisible:!0,drift:l($,n,r,a,t),ondragend:l(H,r,{isEnd:!0})}))})),a}function q(n,r,t,e){var o=e.brushStyle.lineWidth||0,i=O(o,k),a=t[0][0],s=t[1][0],u=a-o/2,c=s-o/2,h=t[0][1],f=t[1][1],l=h-i+o/2,d=f-i+o/2,p=h-a,g=f-s,v=p+o,_=g+o;J(n,r,"main",a,s,p,g),e.transformable&&(J(n,r,"w",u,c,i,_),J(n,r,"e",l,c,i,_),J(n,r,"n",u,c,v,i),J(n,r,"s",u,d,v,i),J(n,r,"nw",u,c,i,i),J(n,r,"ne",l,c,i,i),J(n,r,"sw",u,d,i,i),J(n,r,"se",l,d,i,i))}function F(n,r){var t=r.__brushOption,o=t.transformable,i=r.childAt(0);i.useStyle(Q(t)),i.attr({silent:!o,cursor:o?"move":"default"}),e([["w"],["e"],["n"],["s"],["s","e"],["s","w"],["n","e"],["n","w"]],(function(t){var e=r.childOfName(t.join("")),i=1===t.length?Z(n,t[0]):function(n,r){var t=[Z(n,r[0]),Z(n,r[1])];return("e"===t[0]||"w"===t[0])&&t.reverse(),t.join("")}(n,t);e&&e.attr({silent:!o,invisible:!o,cursor:o?x[i]+"-resize":null})}))}function J(n,r,t,e,o,i,a){var s,u,c,h,f,l=r.childOfName(t);l&&l.setShape((s=tn(n,r,[[e,o],[e+i,o+a]]),u=T(s[0][0],s[1][0]),c=T(s[0][1],s[1][1]),h=O(s[0][0],s[1][0]),f=O(s[0][1],s[1][1]),{x:u,y:c,width:h-u,height:f-c}))}function Q(n){return p({strokeNoScale:!0},n.brushStyle)}function V(n,r,t,e){var o=[T(n,t),T(r,e)],i=[O(n,t),O(r,e)];return[[o[0],i[0]],[o[1],i[1]]]}function Z(n,r){var t=g({w:"left",e:"right",n:"top",s:"bottom"}[r],function(n){return v(n.group)}(n));return{left:"w",right:"e",top:"n",bottom:"s"}[t]}function $(n,r,t,o,i,a){var s=t.__brushOption,u=n.toRectRange(s.range),c=rn(r,i,a);e(o,(function(n){var r=z[n];u[r[0]][r[1]]+=c[r[0]]})),s.range=n.fromRectRange(V(u[0][0],u[1][0],u[0][1],u[1][1])),D(r,t),H(r,{isEnd:!1})}function nn(n,r,t,o){var i=r.__brushOption.range,a=rn(n,t,o);e(i,(function(n){n[0]+=a[0],n[1]+=a[1]})),D(n,r),H(n,{isEnd:!1})}function rn(n,r,t){var e=n.group,o=e.transformCoordToLocal(r,t),i=e.transformCoordToLocal(0,0);return[o[0]-i[0],o[1]-i[1]]}function tn(n,r,t){var e=A(n,r);return e&&e!==w?e.clipPath(t,n._transform):a(t)}function en(n){var r=n.event;r.preventDefault&&r.preventDefault()}function on(n,r,t){return n.childOfName("main").contain(r,t)}function an(n,r,t,e){var o,i=n._creatingCover,s=n._creatingPanel,u=n._brushOption;if(n._track.push(t.slice()),function(n){var r=n._track;if(!r.length)return!1;var t=r[r.length-1],e=r[0],o=t[0]-e[0],i=t[1]-e[1];return R(o*o+i*i,.5)>E}(n)||i){if(s&&!i){"single"===u.brushMode&&G(n);var c=a(u);c.brushType=sn(c.brushType,s),c.panelId=s===w?null:s.panelId,i=n._creatingCover=L(n,c),n._covers.push(i)}if(i){var h=hn[sn(n._brushType,s)];i.__brushOption.range=h.getCreatingRange(tn(n,i,n._track)),e&&(M(n,i),h.updateCommon(n,i)),Y(n,i),o={isEnd:e}}}else e&&"single"===u.brushMode&&u.removeOnClick&&W(n,r,t)&&G(n)&&(o={isEnd:e,removeOnClick:!0});return o}function sn(n,t){return"auto"===n?(r(t&&t.defaultBrushType,'MUST have defaultBrushType when brushType is "atuo"'),t.defaultBrushType):n}var un={mousedown:function(n){if(this._dragging)cn(this,n);else if(!n.target||!n.target.draggable){en(n);var r=this.group.transformCoordToLocal(n.offsetX,n.offsetY);this._creatingCover=null,(this._creatingPanel=W(this,n,r))&&(this._dragging=!0,this._track=[r.slice()])}},mousemove:function(n){var r=n.offsetX,t=n.offsetY,e=this.group.transformCoordToLocal(r,t);if(function(n,r,t){if(n._brushType&&!function(n,r,t){var e=n._zr;return r<0||r>e.getWidth()||t<0||t>e.getHeight()}(n,r.offsetX,r.offsetY)){var e=n._zr,o=n._covers,i=W(n,r,t);if(!n._dragging)for(var a=0;a<o.length;a++){var s=o[a].__brushOption;if(i&&(i===w||s.panelId===i.panelId)&&hn[s.brushType].contain(o[a],t[0],t[1]))return}i&&e.setCursorStyle("crosshair")}}(this,n,e),this._dragging){en(n);var o=an(this,n,e,!1);o&&H(this,o)}},mouseup:function(n){cn(this,n)}};function cn(n,r){if(n._dragging){en(r);var t=r.offsetX,e=r.offsetY,o=n.group.transformCoordToLocal(t,e),i=an(n,r,o,!0);n._dragging=!1,n._track=[],n._creatingCover=null,i&&H(n,i)}}var hn={lineX:fn(0),lineY:fn(1),rect:{createCover:function(n,r){function t(n){return n}return U({toRectRange:t,fromRectRange:t},n,r,[["w"],["e"],["n"],["s"],["s","e"],["s","w"],["n","e"],["n","w"]])},getCreatingRange:function(n){var r=K(n);return V(r[1][0],r[1][1],r[0][0],r[0][1])},updateCoverShape:function(n,r,t,e){q(n,r,t,e)},updateCommon:F,contain:on},polygon:{createCover:function(n,r){var e=new t;return e.add(new h({name:"main",style:Q(r),silent:!0})),e},getCreatingRange:function(n){return n},endCreating:function(n,r){r.remove(r.childAt(0)),r.add(new f({name:"main",draggable:!0,drift:l(nn,n,r),ondragend:l(H,n,{isEnd:!0})}))},updateCoverShape:function(n,r,t,e){r.childAt(0).setShape({points:tn(n,r,t)})},updateCommon:F,contain:on}};function fn(n){return{createCover:function(r,t){return U({toRectRange:function(r){var t=[r,[0,100]];return n&&t.reverse(),t},fromRectRange:function(r){return r[n]}},r,t,[[["w"],["e"]],[["n"],["s"]]][n])},getCreatingRange:function(r){var t=K(r);return[T(t[0][n],t[1][n]),O(t[0][n],t[1][n])]},updateCoverShape:function(r,t,e,o){var i,a=A(r,t);if(a!==w&&a.getLinearBrushOtherExtent)i=a.getLinearBrushOtherExtent(n);else{var s=r._zr;i=[0,[s.getWidth(),s.getHeight()][1-n]]}var u=[e,i];n&&u.reverse(),q(r,t,u,o)},updateCommon:F,contain:on}}var ln=I;function dn(n){return n=vn(n),function(r){return _(r,n)}}function pn(n,r){return n=vn(n),function(t){var e=null!=r?r:t,o=e?n.width:n.height,i=e?n.x:n.y;return[i,i+(o||0)]}}function gn(n,r,t){var e=vn(n);return function(n,o){return e.contain(o[0],o[1])&&!C(n,r,t)}}function vn(n){return m.create(n)}export{ln as B,gn as a,pn as b,dn as m};
